<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyCards Explorer | Aircraft Analytics Dashboard</title>
    
    <!-- External Libraries (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Papaparse for robust CSV Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Chosen Palette: Slate & Sky - Professional Aviation Theme -->
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Chart Containers - Strict Sizing for Responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        @media (min-width: 1024px) { .chart-container { height: 400px; } }

        /* UI Interactions */
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .drag-active {
            border-color: #0ea5e9 !important;
            background-color: #f0f9ff !important;
        }

        /* Animation Utilities */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased overflow-y-scroll">

    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo & Desktop Nav -->
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center mr-8">
                        <span class="text-2xl font-bold text-sky-600 tracking-tight">SkyCards<span class="text-slate-500 font-light">DB</span></span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8" id="desktop-nav">
                        <!-- Nav items injected via JS -->
                    </div>
                </div>
                <!-- Status Indicators -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 shadow-sm" id="db-status-light"></span>
                        <span id="db-status-text">Local Data</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile Nav Placeholder -->
        <div class="sm:hidden border-t border-slate-200" id="mobile-nav-container">
            <div class="flex justify-around p-2 bg-slate-50" id="mobile-nav"></div>
        </div>
    </nav>

    <!-- Main Application Container -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen">
        
        <!-- ================= VIEW: DASHBOARD ================= -->
        <div id="view-dashboard" class="space-y-8 animate-fade-in">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Collection Overview</h1>
                <p class="text-slate-600 max-w-3xl">
                    Welcome to the SkyCards Analytics Hub. To get started, go to the <strong>Manage</strong> tab and drop your "Master" CSV file to populate the charts below.
                </p>
            </div>

            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Planes -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-full">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Planes</p>
                        <p class="mt-2 text-3xl font-extrabold text-slate-900" id="stat-total-planes">0</p>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="bg-sky-600 h-2.5 rounded-full transition-all duration-1000" id="stat-progress-bar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 text-right" id="stat-progress-text">0% Caught</p>
                    </div>
                </div>
                <!-- Top Rarity -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Top Rarity</p>
                    <p class="mt-2 text-3xl font-extrabold text-indigo-600 truncate" id="stat-top-rarity">N/A</p>
                    <p class="text-sm text-slate-400 mt-1">Highest tier acquired</p>
                </div>
                <!-- Battle Ready -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Battle Ready</p>
                    <p class="mt-2 text-3xl font-extrabold text-rose-600" id="stat-battle-count">0</p>
                    <p class="text-sm text-slate-400 mt-1">Cards with Battle Stats</p>
                </div>
                 <!-- Registrations -->
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Registrations</p>
                    <p class="mt-2 text-3xl font-extrabold text-emerald-600" id="stat-registrations">0</p>
                    <p class="text-sm text-slate-400 mt-1">Unique Tail Numbers</p>
                </div>
            </div>

            <!-- Dashboard Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Rarity Donut -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Collection by Rarity</h3>
                    <div class="chart-container">
                        <canvas id="chart-rarity"></canvas>
                    </div>
                </div>
                <!-- Category Bar -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Fleet Composition (Category)</h3>
                    <div class="chart-container">
                        <canvas id="chart-category"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: COLLECTION ================= -->
        <div id="view-collection" class="hidden space-y-6 animate-fade-in">
            <!-- Filter Toolbar -->
            <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 sticky top-20 z-30 transition-all">
                <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                    <!-- Search Bar -->
                    <div class="relative w-full md:w-96">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-slate-400">üîç</span>
                        </div>
                        <input type="text" id="search-input" 
                            class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 sm:text-sm shadow-sm" 
                            placeholder="Search by Name, ICAO, or Model...">
                    </div>
                    <!-- Dropdowns -->
                    <div class="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                        <select id="filter-category" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-lg bg-slate-50">
                            <!-- Populated by JS -->
                        </select>
                        <select id="filter-rarity" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-lg bg-slate-50">
                             <!-- Populated by JS -->
                        </select>
                        <select id="filter-caught" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-lg bg-slate-50">
                            <option value="all">All Status</option>
                            <option value="caught">Caught Only</option>
                            <option value="uncaught">Uncaught Only</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Aircraft Grid -->
            <div id="collection-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards injected by JS -->
            </div>
            
            <div class="text-center py-4">
                <p class="text-sm text-slate-500" id="collection-count-text">Showing 0 aircraft</p>
            </div>
        </div>

        <!-- ================= VIEW: BATTLE LAB ================= -->
        <div id="view-battle" class="hidden space-y-8 animate-fade-in">
             <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Battle Lab Analytics</h1>
                <p class="text-slate-600 max-w-4xl">
                    Identify outliers: Cards with high Victory Rates relative to their Rating. Use the scatter plot to find undervalued gems for specific metas.
                </p>
            </div>

            <!-- Scatter Plot -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Performance Matrix</h3>
                <div class="chart-container">
                    <canvas id="chart-battle-scatter"></canvas>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Battle Roster</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ICAO</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Aircraft</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Meta</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Rating</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Win Rate</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200" id="battle-table-body">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: ADMIN / IMPORT ================= -->
        <div id="view-admin" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Data Management</h1>
                <p class="text-slate-600">
                    Import your "Airpedia (Master).csv" file here to clean and load data. Export your cleaned dataset to various formats for backup or external use.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Import Column -->
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-slate-800 pb-2 border-b border-slate-100">Import</h2>
                    
                    <!-- Drag & Drop Zone -->
                    <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-12 text-center hover:border-sky-500 hover:bg-sky-50 transition-all cursor-pointer bg-white">
                        <div class="space-y-4">
                            <div class="text-4xl">üìÇ</div>
                            <h3 class="text-lg font-medium text-slate-900">Drag & Drop "Master" CSV</h3>
                            <p class="text-sm text-slate-500">or click to browse</p>
                            <input type="file" id="file-input" class="hidden" accept=".csv">
                        </div>
                    </div>

                    <!-- Import Status -->
                    <div id="import-status" class="hidden bg-emerald-50 border border-emerald-200 rounded-lg p-4 animate-fade-in">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <span class="text-emerald-400 text-xl">‚úÖ</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-emerald-800">Import Successful</h3>
                                <div class="mt-2 text-sm text-emerald-700">
                                    <p>Loaded <span id="imported-count" class="font-bold">0</span> aircraft.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Column -->
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-slate-800 pb-2 border-b border-slate-100">Export</h2>
                    <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100 space-y-4">
                        <p class="text-sm text-slate-600 mb-4">Download your cleaned/edited data to use in other apps.</p>
                        
                        <button id="btn-export-csv" class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-white border border-slate-200 rounded-lg text-slate-700 hover:bg-slate-50 hover:border-slate-300 hover:text-sky-600 transition-all group shadow-sm">
                            <span class="text-xl group-hover:scale-110 transition-transform">üìÑ</span>
                            <div class="text-left">
                                <span class="block font-semibold">CSV File</span>
                                <span class="block text-xs text-slate-400">Best for Excel / Google Sheets</span>
                            </div>
                        </button>

                        <button id="btn-export-sql" class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-white border border-slate-200 rounded-lg text-slate-700 hover:bg-slate-50 hover:border-slate-300 hover:text-indigo-600 transition-all group shadow-sm">
                            <span class="text-xl group-hover:scale-110 transition-transform">üóÑÔ∏è</span>
                            <div class="text-left">
                                <span class="block font-semibold">SQL Dump (.sql)</span>
                                <span class="block text-xs text-slate-400">Import to SQLite / Supabase</span>
                            </div>
                        </button>

                        <button id="btn-export-json" class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-white border border-slate-200 rounded-lg text-slate-700 hover:bg-slate-50 hover:border-slate-300 hover:text-amber-600 transition-all group shadow-sm">
                            <span class="text-xl group-hover:scale-110 transition-transform">code</span>
                            <div class="text-left">
                                <span class="block font-semibold">JSON File</span>
                                <span class="block text-xs text-slate-400">For Developers / Backups</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Form -->
            <div class="bg-white rounded-xl shadow-sm p-8 border border-slate-100 max-w-3xl mx-auto mt-8 opacity-75 hover:opacity-100 transition-opacity">
                <h2 class="text-xl font-bold text-slate-800 mb-6 pb-2 border-b border-slate-100">Quick Add (Manual)</h2>
                <form id="add-aircraft-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700">Aircraft Name</label>
                            <input type="text" name="name" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">ICAO Code</label>
                            <input type="text" name="icao" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2 border uppercase">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Rarity</label>
                            <select name="rarity" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2 border">
                                <option>Common</option><option>Rare</option><option>Ultra</option><option>Legendary</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Category</label>
                            <select name="cat" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2 border">
                                <option>Jet & Rocket</option><option>Propeller</option><option>Rotocraft</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="caught" class="rounded border-slate-300 text-sky-600 shadow-sm focus:border-sky-500 focus:ring-sky-500">
                            <span class="ml-2 text-sm text-slate-600">Caught / In Collection</span>
                        </label>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="submit" class="bg-sky-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-sky-700 transition-colors shadow-sm">
                            Save Aircraft
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- ================= MODAL: AIRCRAFT DETAILS ================= -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800" id="modal-title">Aircraft Name</h2>
                    <p class="text-sm text-slate-500 font-mono" id="modal-icao">ICAO: ----</p>
                </div>
                <button id="modal-close" class="text-slate-400 hover:text-slate-600 transition-colors bg-white rounded-full p-2 shadow-sm hover:shadow">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Body (Scrollable) -->
            <div class="p-6 overflow-y-auto">
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Left: Key Stats & Badges -->
                    <div class="md:w-1/3 space-y-6">
                        <div class="bg-sky-50 rounded-xl p-4 border border-sky-100 text-center">
                            <span class="block text-xs font-semibold text-sky-600 uppercase tracking-wider mb-1">Status</span>
                            <span id="modal-status" class="text-lg font-bold text-sky-900">Caught</span>
                        </div>
                        
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Category</h4>
                            <p id="modal-cat" class="text-slate-800 font-medium">--</p>
                            <p id="modal-subcat" class="text-slate-600 text-sm">--</p>
                        </div>
                    </div>

                    <!-- Right: Technical Specs -->
                    <div class="md:w-2/3">
                        <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                            <span>Technical Specifications</span>
                            <div class="h-px bg-slate-200 flex-grow"></div>
                        </h3>
                        
                        <div class="grid grid-cols-2 gap-y-4 gap-x-8">
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Max Speed</p>
                                <p id="modal-speed" class="text-base font-medium text-slate-800">-- kt</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Range</p>
                                <p id="modal-range" class="text-base font-medium text-slate-800">-- NM</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Ceiling</p>
                                <p id="modal-ceiling" class="text-base font-medium text-slate-800">-- ft</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Weight (MTOW)</p>
                                <p id="modal-weight" class="text-base font-medium text-slate-800">-- t</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Rarity Score</p>
                                <p id="modal-rarity-score" class="text-base font-medium text-slate-800">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- 1. DATA MANAGER & CSV CLEANING ---
        class DataManager {
            constructor() {
                this.data = [];
            }

            // Load new data (replaces or appends)
            loadData(newData) {
                if(newData && newData.length > 0) {
                    this.data = newData;
                } else if (this.data.length === 0) {
                    // Default Mock Data (If user hasn't uploaded yet)
                    this.data = [
                        { icao: "B738", name: "BOEING 737-800", cat: "Jet & Rocket", sub: "Twin Engine", caught: true, rarity: "Common", speed: 455, range: 2935, ceiling: 41000, weight: 79.0 },
                        { icao: "A380", name: "AIRBUS A380", cat: "Jet & Rocket", sub: "4+ Engine", caught: false, rarity: "Rare", speed: 560, range: 8000, ceiling: 43000, weight: 575.0 },
                        { icao: "C172", name: "CESSNA 172", cat: "Propeller", sub: "Single Engine", caught: true, rarity: "Common", speed: 122, range: 640, ceiling: 14000, weight: 1.1 }
                    ];
                }
                return this.data;
            }

            addAircraft(obj) {
                this.data.push(obj);
                return true;
            }
        }

        // --- 2. GLOBAL STATE ---
        const dm = new DataManager();
        let db = []; // The active database
        const state = {
            view: 'dashboard',
            filters: { search: '', category: 'all', rarity: 'all', caught: 'all' },
            charts: {} // Store chart instances
        };

        // --- 3. DOM ELEMENTS ---
        const els = {
            navDesktop: document.getElementById('desktop-nav'),
            navMobile: document.getElementById('mobile-nav'),
            views: {
                dashboard: document.getElementById('view-dashboard'),
                collection: document.getElementById('view-collection'),
                battle: document.getElementById('view-battle'),
                admin: document.getElementById('view-admin')
            },
            stats: {
                total: document.getElementById('stat-total-planes'),
                bar: document.getElementById('stat-progress-bar'),
                text: document.getElementById('stat-progress-text'),
                rarity: document.getElementById('stat-top-rarity'),
                battle: document.getElementById('stat-battle-count'),
                regs: document.getElementById('stat-registrations')
            },
            collection: {
                grid: document.getElementById('collection-grid'),
                count: document.getElementById('collection-count-text'),
                search: document.getElementById('search-input'),
                catFilter: document.getElementById('filter-category'),
                rarityFilter: document.getElementById('filter-rarity'),
                caughtFilter: document.getElementById('filter-caught')
            },
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            form: document.getElementById('add-aircraft-form')
        };

        // --- 4. INIT & NAVIGATION ---
        async function init() {
            db = dm.loadData();
            setupNav();
            setupDragAndDrop();
            setupEventListeners();
            populateFilters();
            
            // Start at Dashboard
            switchView('dashboard');
        }

        function setupNav() {
            const tabs = [
                { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                { id: 'collection', label: 'Collection', icon: '‚úàÔ∏è' },
                { id: 'battle', label: 'Battle Lab', icon: '‚öîÔ∏è' },
                { id: 'admin', label: 'Manage', icon: '‚öôÔ∏è' }
            ];

            const createLink = (tab, isMobile) => {
                const btn = document.createElement('button');
                btn.dataset.target = tab.id;
                btn.addEventListener('click', () => switchView(tab.id));
                
                if (isMobile) {
                    btn.className = `flex flex-col items-center text-xs font-medium p-2 rounded-lg transition-colors text-slate-500`;
                    btn.innerHTML = `<span class="text-xl mb-1">${tab.icon}</span>${tab.label}`;
                } else {
                    btn.className = `inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300`;
                    btn.innerHTML = `${tab.label}`;
                }
                return btn;
            };

            tabs.forEach(t => {
                els.navDesktop.appendChild(createLink(t, false));
                els.navMobile.appendChild(createLink(t, true));
            });
        }

        function switchView(viewId) {
            state.view = viewId;
            
            // Toggle Views
            Object.keys(els.views).forEach(key => {
                const el = els.views[key];
                if (key === viewId) {
                    el.classList.remove('hidden');
                    // Trigger specific render logic
                    if (key === 'dashboard') renderDashboard();
                    if (key === 'collection') renderCollection();
                    if (key === 'battle') renderBattle();
                } else {
                    el.classList.add('hidden');
                }
            });

            // Update Nav State
            [...els.navDesktop.children].forEach(btn => {
                const active = btn.dataset.target === viewId;
                btn.classList.toggle('border-sky-500', active);
                btn.classList.toggle('text-slate-900', active);
                btn.classList.toggle('border-transparent', !active);
                btn.classList.toggle('text-slate-500', !active);
            });
        }

        // --- 5. CSV CLEANING ROBOT ---
        function cleanCSV(results) {
            const rawData = results.data;
            const headers = results.meta.fields;
            const cleanedData = [];

            // Helper: Find which header corresponds to our internal keys
            // This handles the user's "XP (+/- 2)" and "Rarity Category" complexity
            const mapHeader = (h) => {
                const l = h.toLowerCase();
                if(l.includes('icao')) return 'icao';
                if(l.includes('aircraft')) return 'name';
                if(l.includes('subcategory')) return 'sub';
                if(l.includes('category') && !l.includes('rarity')) return 'cat'; 
                if(l.includes('rarity category')) return 'rarity'; // Prioritize category
                if(l.includes('rarity') && !l.includes('category')) return 'rarityScore';
                if(l.includes('caught')) return 'caught';
                if(l.includes('speed')) return 'speed';
                if(l.includes('range')) return 'range';
                if(l.includes('ceiling')) return 'ceiling';
                if(l.includes('weight')) return 'weight';
                return null;
            };

            const indices = {};
            headers.forEach(h => {
                const key = mapHeader(h);
                if(key) indices[key] = h;
            });

            rawData.forEach(row => {
                // Must have ICAO
                if (!row[indices.icao]) return;

                const cleanNum = (val) => {
                    if(!val) return 0;
                    return parseFloat(String(val).replace(/,/g, '').replace('--', '0')) || 0;
                };

                const cleanBool = (val) => {
                    const s = String(val).toUpperCase();
                    return s === 'TRUE' || s === 'YES' || s === '1';
                };

                const plane = {
                    icao: row[indices.icao],
                    name: row[indices.name] || 'Unknown',
                    cat: row[indices.cat] || 'Unknown',
                    sub: row[indices.sub] || '',
                    rarity: row[indices.rarity] || 'Common', // Default to Common
                    caught: cleanBool(row[indices.caught]),
                    speed: cleanNum(row[indices.speed]),
                    range: cleanNum(row[indices.range]),
                    ceiling: cleanNum(row[indices.ceiling]),
                    weight: cleanNum(row[indices.weight]),
                    rarityScore: cleanNum(row[indices.rarityScore]),
                    // Battle Stats Mock (Since CSV might not have them)
                    battle: null 
                };
                cleanedData.push(plane);
            });

            return cleanedData;
        }

        // --- 6. DRAG & DROP LOGIC ---
        function setupDragAndDrop() {
            const dz = els.dropZone;
            const inp = els.fileInput;

            const highlight = () => dz.classList.add('drag-active');
            const unhighlight = () => dz.classList.remove('drag-active');

            ['dragenter', 'dragover'].forEach(e => dz.addEventListener(e, (ev) => { ev.preventDefault(); highlight(); }));
            ['dragleave', 'drop'].forEach(e => dz.addEventListener(e, (ev) => { ev.preventDefault(); unhighlight(); }));

            dz.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });

            dz.addEventListener('click', () => inp.click());
            inp.addEventListener('change', (e) => handleFile(e.target.files[0]));
        }

        function handleFile(file) {
            if (file && file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log("Parsing Complete", results);
                        const cleanPlanes = cleanCSV(results);
                        
                        // Update Data
                        db = dm.loadData(cleanPlanes);
                        
                        // Update UI
                        document.getElementById('import-status').classList.remove('hidden');
                        document.getElementById('imported-count').textContent = cleanPlanes.length;
                        
                        // Re-render
                        populateFilters();
                        alert(`Success! Imported ${cleanPlanes.length} aircraft.`);
                        switchView('dashboard');
                    }
                });
            } else {
                alert("Please upload a valid .csv file");
            }
        }

        // --- 7. EXPORT LOGIC (NEW) ---
        function triggerDownload(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            if(db.length === 0) return alert("No data to export!");
            const csv = Papa.unparse(db);
            triggerDownload(csv, 'SkyCards_Cleaned.csv', 'text/csv');
        }

        function exportJSON() {
            if(db.length === 0) return alert("No data to export!");
            const json = JSON.stringify(db, null, 2);
            triggerDownload(json, 'SkyCards_Data.json', 'application/json');
        }

        function exportSQL() {
            if(db.length === 0) return alert("No data to export!");
            
            // Generate SQL statements
            let sql = `CREATE TABLE IF NOT EXISTS aircraft (
    icao TEXT PRIMARY KEY,
    name TEXT,
    category TEXT,
    subcategory TEXT,
    rarity TEXT,
    caught BOOLEAN,
    speed REAL,
    range REAL,
    ceiling REAL,
    weight REAL,
    rarity_score REAL
);\n\n`;

            sql += "BEGIN TRANSACTION;\n";
            db.forEach(p => {
                const escape = (str) => str ? `'${String(str).replace(/'/g, "''")}'` : 'NULL';
                const val = (v) => v !== undefined && v !== null ? v : 'NULL';
                const bool = (b) => b ? 1 : 0;

                sql += `INSERT OR REPLACE INTO aircraft VALUES (${escape(p.icao)}, ${escape(p.name)}, ${escape(p.cat)}, ${escape(p.sub)}, ${escape(p.rarity)}, ${bool(p.caught)}, ${val(p.speed)}, ${val(p.range)}, ${val(p.ceiling)}, ${val(p.weight)}, ${val(p.rarityScore)});\n`;
            });
            sql += "COMMIT;\n";

            triggerDownload(sql, 'SkyCards_Dump.sql', 'application/sql');
        }

        // --- 8. RENDERING: DASHBOARD ---
        function renderDashboard() {
            const total = db.length;
            const captured = db.filter(a => a.caught).length;
            
            // Text Stats
            els.stats.total.textContent = total.toLocaleString();
            const pct = total > 0 ? ((captured / total) * 100).toFixed(1) : 0;
            els.stats.bar.style.width = `${pct}%`;
            els.stats.text.textContent = `${pct}% Caught (${captured})`;
            
            const rarities = db.filter(a => a.caught).map(a => a.rarity);
            let topRarity = 'None';
            if(rarities.includes('Legendary')) topRarity = 'Legendary';
            else if(rarities.includes('Ultra')) topRarity = 'Ultra';
            else if(rarities.includes('Rare')) topRarity = 'Rare';
            else if(rarities.length > 0) topRarity = 'Common';
            els.stats.rarity.textContent = topRarity;

            els.stats.battle.textContent = db.filter(a => a.battle).length;
            els.stats.regs.textContent = "12,318"; // Placeholder until reg CSV parsed

            // Chart: Rarity
            const rCounts = {};
            db.forEach(a => { rCounts[a.rarity] = (rCounts[a.rarity] || 0) + 1; });
            renderChart('chart-rarity', 'doughnut', {
                labels: Object.keys(rCounts),
                datasets: [{
                    data: Object.values(rCounts),
                    backgroundColor: ['#e2e8f0', '#7dd3fc', '#818cf8', '#fbbf24'],
                    borderWidth: 0
                }]
            });

            // Chart: Category
            const cCounts = {};
            db.forEach(a => { cCounts[a.cat] = (cCounts[a.cat] || 0) + 1; });
            renderChart('chart-category', 'bar', {
                labels: Object.keys(cCounts),
                datasets: [{
                    label: 'Aircraft Count',
                    data: Object.values(cCounts),
                    backgroundColor: '#0ea5e9',
                    borderRadius: 4
                }]
            }, { 
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            });
        }

        function renderChart(id, type, data, extraOpts = {}) {
            const ctx = document.getElementById(id).getContext('2d');
            if(state.charts[id]) state.charts[id].destroy();
            state.charts[id] = new Chart(ctx, {
                type, data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    ...extraOpts
                }
            });
        }

        // --- 9. RENDERING: COLLECTION ---
        function renderCollection() {
            const grid = els.collection.grid;
            grid.innerHTML = '';
            
            const f = state.filters;
            const filtered = db.filter(a => {
                const s = f.search.toLowerCase();
                const matchSearch = a.name.toLowerCase().includes(s) || a.icao.toLowerCase().includes(s);
                const matchCat = f.category === 'all' || a.cat === f.category;
                const matchRarity = f.rarity === 'all' || a.rarity === f.rarity;
                const matchCaught = f.caught === 'all' || (f.caught === 'caught' && a.caught) || (f.caught === 'uncaught' && !a.caught);
                return matchSearch && matchCat && matchRarity && matchCaught;
            });

            els.collection.count.textContent = `Showing ${filtered.length} aircraft`;

            filtered.forEach(a => {
                const el = document.createElement('div');
                el.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card-hover cursor-pointer transition-all duration-200';
                el.onclick = () => openModal(a);

                // Styling based on Rarity
                let colorClass = 'bg-slate-50 text-slate-800 border-slate-200';
                if(a.rarity === 'Rare') colorClass = 'bg-sky-50 text-sky-800 border-sky-200';
                if(a.rarity === 'Ultra') colorClass = 'bg-indigo-50 text-indigo-800 border-indigo-200';
                
                el.innerHTML = `
                    <div class="h-32 bg-slate-100 relative flex items-center justify-center">
                        <div class="text-4xl opacity-25">‚úàÔ∏è</div>
                        ${a.caught ? '<span class="absolute top-2 right-2 bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded-full">Caught</span>' : ''}
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-mono text-slate-400">${a.icao}</span>
                            <span class="text-xs px-2 py-0.5 rounded border ${colorClass}">${a.rarity}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 text-sm mb-1 truncate">${a.name}</h3>
                        <div class="flex justify-between text-xs text-slate-400 border-t border-slate-100 pt-2">
                            <span>${a.speed || '--'} kt</span>
                            <span>${a.range || '--'} NM</span>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        // --- 10. RENDERING: BATTLE ---
        function renderBattle() {
            const tbody = document.getElementById('battle-table-body');
            tbody.innerHTML = '';
            // For demo, if no battle stats, create fake ones based on Rarity Score
            const battleItems = db.map(a => ({
                ...a,
                rating: a.battle ? a.battle.rating : Math.floor((a.rarityScore || 1) * 100),
                winRate: a.battle ? a.battle.winRate : (Math.random() * 3).toFixed(1)
            })).sort((a,b) => b.rating - a.rating).slice(0, 50); // Top 50

            battleItems.forEach(a => {
                tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-900">${a.icao}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${a.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 py-1 bg-slate-100 rounded text-xs">Simulated</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-slate-700">${a.rating}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-slate-700">${a.winRate}</td>
                    </tr>
                `;
            });

            // Scatter
            const scatterData = battleItems.map(a => ({ x: a.rating, y: a.winRate, name: a.name }));
            renderChart('chart-battle-scatter', 'scatter', {
                datasets: [{
                    label: 'Battle Performance',
                    data: scatterData,
                    backgroundColor: '#3b82f6',
                    pointRadius: 5
                }]
            }, {
                plugins: { tooltip: { callbacks: { label: (ctx) => `${ctx.raw.name}: ${ctx.raw.x} Rating` } } },
                scales: { x: { title: { display: true, text: 'Rating' } }, y: { title: { display: true, text: 'Win Rate' } } }
            });
        }

        // --- 11. FILTERS & EVENTS ---
        function populateFilters() {
            const cats = [...new Set(db.map(a => a.cat))].sort();
            const rarities = [...new Set(db.map(a => a.rarity))].sort();

            const fill = (el, items) => {
                const prev = el.value;
                el.innerHTML = '<option value="all">All</option>';
                items.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
                el.value = prev;
            };

            fill(els.collection.catFilter, cats);
            fill(els.collection.rarityFilter, rarities);
        }

        function setupEventListeners() {
            // Filter changes
            const update = (k, v) => { state.filters[k] = v; renderCollection(); };
            els.collection.search.addEventListener('input', (e) => update('search', e.target.value));
            els.collection.catFilter.addEventListener('change', (e) => update('category', e.target.value));
            els.collection.rarityFilter.addEventListener('change', (e) => update('rarity', e.target.value));
            els.collection.caughtFilter.addEventListener('change', (e) => update('caught', e.target.value));

            // Export Buttons
            document.getElementById('btn-export-csv').addEventListener('click', exportCSV);
            document.getElementById('btn-export-json').addEventListener('click', exportJSON);
            document.getElementById('btn-export-sql').addEventListener('click', exportSQL);

            // Manual Form
            els.form.addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(els.form);
                const obj = {
                    name: fd.get('name'),
                    icao: fd.get('icao').toUpperCase(),
                    rarity: fd.get('rarity'),
                    cat: fd.get('cat'),
                    caught: fd.get('caught') === 'on',
                    sub: 'Manual Entry'
                };
                dm.addAircraft(obj);
                alert("Saved!");
                els.form.reset();
                populateFilters();
            });

            // Modal
            const close = () => {
                const c = document.getElementById('modal-content');
                c.classList.remove('scale-100', 'opacity-100');
                c.classList.add('scale-95', 'opacity-0');
                setTimeout(() => document.getElementById('modal-overlay').classList.add('hidden'), 300);
            };
            document.getElementById('modal-close').addEventListener('click', close);
            document.getElementById('modal-overlay').addEventListener('click', (e) => { if(e.target.id === 'modal-overlay') close(); });
        }

        function openModal(a) {
            document.getElementById('modal-title').textContent = a.name;
            document.getElementById('modal-icao').textContent = `ICAO: ${a.icao}`;
            document.getElementById('modal-status').textContent = a.caught ? 'Caught' : 'Uncaught';
            document.getElementById('modal-status').className = a.caught ? 'text-lg font-bold text-emerald-600' : 'text-lg font-bold text-slate-400';
            
            document.getElementById('modal-cat').textContent = a.cat;
            document.getElementById('modal-subcat').textContent = a.sub;
            document.getElementById('modal-speed').textContent = a.speed ? `${a.speed} kt` : '--';
            document.getElementById('modal-range').textContent = a.range ? `${a.range} NM` : '--';
            document.getElementById('modal-ceiling').textContent = a.ceiling ? `${a.ceiling} ft` : '--';
            document.getElementById('modal-weight').textContent = a.weight ? `${a.weight} t` : '--';
            document.getElementById('modal-rarity-score').textContent = a.rarityScore || '--';

            const ov = document.getElementById('modal-overlay');
            const c = document.getElementById('modal-content');
            ov.classList.remove('hidden');
            setTimeout(() => { c.classList.remove('scale-95', 'opacity-0'); c.classList.add('scale-100', 'opacity-100'); }, 10);
        }

        // --- BOOT ---
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
